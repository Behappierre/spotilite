<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SpotiLite – Minimal Spotify Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #10161d;
      --muted: #8fa0b3;
      --text: #e7eef7;
      --accent: #1db954;
      --ring: 0 0 0 3px color-mix(in oklab, var(--accent) 35%, transparent);
      --radius: 14px;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; background: radial-gradient(1200px 800px at 20% -20%, #14202d 0%, #0b0f14 60%), var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    a { color: inherit; text-decoration: none; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 16px; margin-bottom: 24px; }
    .logo { display:flex; align-items:center; gap: 12px; font-weight: 700; letter-spacing:.2px; }
    .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 6px rgba(29,185,84,.2); }
    .title { font-size: 18px; color: #cfe2f2; }
    .card { background: color-mix(in oklab, var(--panel) 92%, #0a0a0a); border: 1px solid rgba(255,255,255,.05); border-radius: var(--radius); box-shadow: var(--shadow); overflow: clip; }
    .toolbar { 
      position: sticky; 
      top: 0; 
      z-index: 100; 
      background: color-mix(in oklab, var(--panel) 92%, #0a0a0a); 
      display:flex; 
      align-items:center; 
      gap: 10px; 
      padding: 14px; 
      border-bottom: 1px solid rgba(255,255,255,.06); 
      backdrop-filter: blur(10px);
    }
    .btn, button { background: linear-gradient(180deg, #1db954, #159c45); color: white; border: 0; padding: 10px 14px; border-radius: 999px; font-weight: 600; cursor: pointer; transition: transform .06s ease, box-shadow .2s ease; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(29,185,84,.25); }
    .btn.secondary { background: #151c24; color: #cfe2f2; border: 1px solid rgba(255,255,255,.08); }
    .btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,.12); color: #d5e6f8; }
    .right { margin-left: auto; display:flex; gap:8px; }
    .searchbar { display:flex; align-items:center; gap:10px; width: 100%; }
    .searchbar input {
      width: 100%; padding: 12px 14px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08); background: #0e141b; color: var(--text);
      outline: none; box-shadow: none; font-size: 15px;
    }
    .searchbar input:focus { box-shadow: var(--ring); border-color: color-mix(in oklab, var(--accent) 30%, #000); }
    .pills { display:flex; flex-wrap: wrap; gap: 6px; }
    .pill { padding: 7px 12px; border-radius: 999px; background: #0f1720; border: 1px solid rgba(255,255,255,.08); color: #cfe2f2; cursor: pointer; font-weight: 600; font-size: 12px; letter-spacing:.2px; }
    .pill.active { background: #132534; border-color: #1db95455; color: #dff6e8; }
    .results { padding: 10px; display:grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 14px; }
    .item { background: #0e151d; border: 1px solid rgba(255,255,255,.06); border-radius: 14px; overflow:hidden; display:flex; flex-direction:column; }
    .cover { width:100%; aspect-ratio: 1/1; background:#121a23; object-fit: cover; }
    .meta { padding: 10px 12px; display:flex; flex-direction:column; gap: 6px; }
    .name { font-weight: 700; line-height: 1.2; }
    .sub  { color: var(--muted); font-size: 12px; }
    .row  { display:flex; align-items:center; gap: 8px; }
    .open { display:inline-flex; align-items:center; gap:6px; font-size: 12px; padding: 6px 9px; border-radius: 999px; background: #0f1b12; border: 1px solid #1db95444; color: #aee6bf; }
    footer { margin-top: 14px; color: #93a9be; font-size: 12px; opacity: .9; }
    .notice { margin-top: 10px; color:#93a9be; }
    .avatar { width:28px; height:28px; border-radius:50%; border:1px solid rgba(255,255,255,.2); }
    .tag { font-size: 11px; padding: 4px 8px; border: 1px solid rgba(255,255,255,.12); border-radius: 999px; color:#b9c9da; }
    .empty { padding: 22px; color:#9fb3c7; }
    .btn-play { display:inline-flex; align-items:center; gap:6px; font-size: 12px; padding: 6px 9px; border-radius: 999px; background: #1db954; border: 1px solid #1db954; color: white; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
    .btn-play:hover { background: #1ed760; transform: scale(1.05); }
    .btn-play.playing { background: #e74c3c; border-color: #e74c3c; }
    .btn-play.playing:hover { background: #c0392b; }
    .no-preview { font-size: 11px; color: #8fa0b3; font-style: italic; }
    .audio-player { position: fixed; bottom: 0; left: 0; right: 0; background: #0e151d; border-top: 1px solid rgba(255,255,255,.1); padding: 16px; z-index: 1000; display: none; }
    .audio-player.active { display: block; }
    .audio-player-content { max-width: 980px; margin: 0 auto; display: flex; align-items: center; gap: 16px; }
    .now-playing { flex: 1; }
    .now-playing-title { font-weight: 700; color: #e7eef7; margin-bottom: 4px; }
    .now-playing-artist { font-size: 12px; color: #8fa0b3; }
    .audio-controls { display: flex; align-items: center; gap: 12px; }
    .audio-controls button { background: none; border: none; color: #e7eef7; cursor: pointer; padding: 8px; border-radius: 50%; transition: background 0.2s ease; }
    .audio-controls button:hover { background: rgba(255,255,255,.1); }
    .progress-bar { 
      flex: 1; 
      height: 4px; 
      background: rgba(255,255,255,.1); 
      border-radius: 2px; 
      overflow: hidden; 
      cursor: pointer;
      position: relative;
    }
    .progress-bar:hover { 
      height: 6px; 
      background: rgba(255,255,255,.15);
    }
    .progress-fill { 
      height: 100%; 
      background: #1db954; 
      width: 0%; 
      transition: width 0.1s ease; 
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><span class="dot"></span><span class="title">SpotiLite</span></div>
      <div class="right" id="authArea">
        <!-- Filled by JS (login / profile / logout) -->
      </div>
    </header>

    <div class="card">
      <div class="toolbar">
        <form id="searchForm" class="searchbar" autocomplete="off">
          <input id="q" placeholder="Search songs, artists, albums, playlists…" />
          <button class="btn" type="submit">Search</button>
        </form>
        <div class="right pills" id="typePills"></div>
      </div>
      <div id="results" class="results"></div>
      <div id="empty" class="empty" style="display:none;">Try a search to see results here.</div>
    </div>

    <footer>
      Built with Spotify Web API + Web Playback SDK. Full playback available with Premium account. 
    </footer>
    <div class="notice" id="notice"></div>
  </div>

  <!-- Audio Player -->
  <div class="audio-player" id="audioPlayer">
    <div class="audio-player-content">
      <div class="now-playing">
        <div class="now-playing-title" id="nowPlayingTitle">No track playing</div>
        <div class="now-playing-artist" id="nowPlayingArtist"></div>
      </div>
             <div class="progress-bar" onclick="seekToPosition(event)">
         <div class="progress-fill" id="progressFill"></div>
       </div>
             <div class="audio-controls">
                   <button onclick="playPreviousTrack()" title="Previous Track">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
            </svg>
          </button>
         <button id="playPauseBtn" onclick="toggleWebPlayback()">
           <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
             <path d="M8 5v14l11-7z"/>
           </svg>
         </button>
                   <button onclick="playNextTrack()" title="Next Track">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 6h2v12h-2zm-3.5 6l-8.5 6V6z"/>
            </svg>
          </button>
                   <button onclick="stopWebPlayback()" title="Stop">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 6h12v12H6z"/>
            </svg>
          </button>
       </div>
    </div>
  </div>

  <script type="module">
    // -----------------------------
    // CONFIG
    // -----------------------------
    const CLIENT_ID = "62d29f2066a04424b311e12cb4d58027"; // Your Spotify Client ID
    const REDIRECT_URI = window.location.origin + window.location.pathname; // use the same page
    const SCOPES = ["user-read-email", "user-read-private", "streaming"]; // includes streaming for full playback

    // Search types toggles
    const TYPES = ["track","artist","album","playlist"];
    const stateKey = "spotilite_state_v1";

    // -----------------------------
    // PKCE HELPERS (per Spotify docs)
    // -----------------------------
    const generateRandomString = (length) => {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      const values = crypto.getRandomValues(new Uint8Array(length));
      return Array.from(values).map(v => possible[v % possible.length]).join('');
    };
    const sha256 = async (plain) => {
      const enc = new TextEncoder().encode(plain);
      return await crypto.subtle.digest('SHA-256', enc);
    };
    const base64url = (arrayBuffer) => {
      return btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)))
        .replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
    };

    async function login() {
      const codeVerifier = generateRandomString(64);
      localStorage.setItem("code_verifier", codeVerifier);
      const codeChallenge = base64url(await sha256(codeVerifier));
      const state = generateRandomString(16);
      localStorage.setItem(stateKey, state);

      const params = new URLSearchParams({
        response_type: "code",
        client_id: CLIENT_ID,
        scope: SCOPES.join(" "),
        code_challenge_method: "S256",
        code_challenge: codeChallenge,
        redirect_uri: REDIRECT_URI,
        state
      });

      window.location.assign(`https://accounts.spotify.com/authorize?${params.toString()}`);
    }

    async function exchangeCodeForToken(code) {
      const code_verifier = localStorage.getItem("code_verifier");
      const body = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: "authorization_code",
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier
      });
      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error_description || data.error);
      const expires_at = Date.now() + (data.expires_in * 1000) - 10_000;
      localStorage.setItem("spotilite_token", JSON.stringify({
        access_token: data.access_token,
        refresh_token: data.refresh_token,
        token_type: data.token_type,
        expires_at
      }));
      history.replaceState({}, document.title, REDIRECT_URI); // clean URL
      return data.access_token;
    }

    async function refreshToken() {
      const raw = localStorage.getItem("spotilite_token");
      if (!raw) return null;
      const tok = JSON.parse(raw);
      if (!tok.refresh_token) return null;
      const body = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: "refresh_token",
        refresh_token: tok.refresh_token
      });
      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error_description || data.error);
      const expires_at = Date.now() + (data.expires_in * 1000) - 10_000;
      const updated = {
        access_token: data.access_token,
        refresh_token: data.refresh_token || tok.refresh_token, // may not always return a new one
        token_type: data.token_type || tok.token_type,
        expires_at
      };
      localStorage.setItem("spotilite_token", JSON.stringify(updated));
      return updated.access_token;
    }

    async function getAccessToken() {
      const raw = localStorage.getItem("spotilite_token");
      if (!raw) return null;
      const tok = JSON.parse(raw);
      if (Date.now() < tok.expires_at && tok.access_token) return tok.access_token;
      try { return await refreshToken(); } catch { logout(); return null; }
    }

    function logout() {
      localStorage.removeItem("spotilite_token");
      localStorage.removeItem("code_verifier");
      localStorage.removeItem(stateKey);
      location.reload();
    }

    // -----------------------------
    // UI + SEARCH
    // -----------------------------
    const authArea = document.getElementById("authArea");
    const notice = document.getElementById("notice");
    const results = document.getElementById("results");
    const empty = document.getElementById("empty");
    const typePills = document.getElementById("typePills");
    const selected = new Set(["track","artist"]);

    function pill(label) {
      const el = document.createElement("button");
      el.className = "pill" + (selected.has(label) ? " active" : "");
      el.textContent = label;
      el.onclick = () => {
        if (selected.has(label)) selected.delete(label); else selected.add(label);
        el.classList.toggle("active");
      };
      return el;
    }
    TYPES.forEach(t => typePills.appendChild(pill(t)));

    function setAuthUI(profile) {
      authArea.innerHTML = "";
      if (!profile) {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "Log in with Spotify";
        btn.onclick = login;
        authArea.appendChild(btn);
      } else {
        const avatar = document.createElement("img");
        avatar.className = "avatar";
        avatar.src = profile?.images?.[0]?.url || "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = profile.display_name || profile.id;
        const out = document.createElement("button");
        out.className = "btn secondary";
        out.textContent = "Log out";
        out.onclick = logout;
        authArea.append(avatar, tag, out);
      }
    }

    async function fetchJSON(url, token) {
      const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` }});
      if (res.status === 401) { // token expired fallback
        await refreshToken();
        const t2 = await getAccessToken();
        if (!t2) throw new Error("Auth expired");
        return fetchJSON(url, t2);
      }
      if (!res.ok) throw new Error(`${res.status}: ${await res.text()}`);
      return res.json();
    }

    function fmtArtists(artists) {
      return (artists || []).map(a => a.name).join(", ");
    }

    function cardImage(images) {
      // Spotify sends widest-first; pick mid if available
      if (!images || !images.length) return "";
      const img = images[Math.min(1, images.length - 1)].url;
      return img;
    }

    function renderItems(payload) {
      results.innerHTML = "";
      const blocks = [];
      const add = (arr, kind) => {
        arr.forEach(item => {
          const div = document.createElement("div");
          div.className = "item";
          const imgSrc =
            kind === "track" ? cardImage(item.album?.images)
          : kind === "artist" ? cardImage(item.images)
          : cardImage(item.images);
          const link = (item.external_urls && item.external_urls.spotify) || "#";

          div.innerHTML = `
            ${imgSrc ? `<img class="cover" src="${imgSrc}" alt="">` : `<div class="cover"></div>`}
            <div class="meta">
              <div class="row" style="justify-content:space-between;">
                <span class="pill" style="border-color:#1db95433;background:#0f1b12;color:#bfead0;">${kind}</span>
                ${kind === "track" ? `<span class="sub">${Math.round(item.popularity)||0}★</span>` : ""}
              </div>
              <div class="name">${escapeHtml(kind === "track" || kind === "album" ? item.name : item.name)}</div>
              <div class="sub">${
                kind === "track" ? `${fmtArtists(item.artists)} · ${item.album?.name || ""}` :
                kind === "album" ? `${fmtArtists(item.artists)}` :
                kind === "playlist" ? `${item.tracks?.total || 0} tracks` :
                kind === "artist" ? `${(item.followers && item.followers.total) ? new Intl.NumberFormat().format(item.followers.total) + " followers" : ""}` : ""
              }</div>
                             <div class="row" style="margin-top:6px; gap:8px;">
                 ${kind === "track" ? 
                   `<button class="btn-play" onclick="playFullTrack('${item.uri}')">
                     <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                       <path d="M8 5v14l11-7z"/>
                     </svg>
                     Play Full
                   </button>` : ''
                 }
                 <a class="open" href="${link}" target="_blank" rel="noopener">
                   Open in Spotify
                   <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3Zm5 14v2H5V5h2v12h12Z"/></svg>
                 </a>
               </div>
            </div>`;
          blocks.push(div);
        });
      };

      if (payload.tracks) add(payload.tracks.items || [], "track");
      if (payload.artists) add(payload.artists.items || [], "artist");
      if (payload.albums) add(payload.albums.items || [], "album");
      if (payload.playlists) add(payload.playlists.items || [], "playlist");

      if (!blocks.length) {
        empty.style.display = "block";
        results.innerHTML = "";
      } else {
        empty.style.display = "none";
        blocks.forEach(b => results.appendChild(b));
      }
    }

    function escapeHtml(s="") {
      return s.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
    }

    // Audio player functionality
    let currentAudio = null;
    let isPlaying = false;
    let currentTrack = null;

    function playPreview(previewUrl, trackName) {
      // Stop any currently playing audio
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }

      // Create new audio element
      currentAudio = new Audio(previewUrl);
      currentTrack = trackName;
      
      // Update UI
      document.getElementById('nowPlayingTitle').textContent = trackName;
      document.getElementById('nowPlayingArtist').textContent = 'Preview (30s)';
      document.getElementById('audioPlayer').classList.add('active');
      
      // Update play button
      const playBtn = document.getElementById('playPauseBtn');
      playBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
      
      // Play audio
      currentAudio.play();
      isPlaying = true;
      
      // Update progress bar
      currentAudio.addEventListener('timeupdate', updateProgress);
      
      // Handle audio end
      currentAudio.addEventListener('ended', () => {
        stopAudio();
      });
    }

    function togglePlayPause() {
      if (!currentAudio) return;
      
      if (isPlaying) {
        currentAudio.pause();
        document.getElementById('playPauseBtn').innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
        isPlaying = false;
      } else {
        currentAudio.play();
        document.getElementById('playPauseBtn').innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
        isPlaying = true;
      }
    }

    function stopAudio() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      isPlaying = false;
      document.getElementById('audioPlayer').classList.remove('active');
      document.getElementById('nowPlayingTitle').textContent = 'No track playing';
      document.getElementById('nowPlayingArtist').textContent = '';
      document.getElementById('playPauseBtn').innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
      document.getElementById('progressFill').style.width = '0%';
    }

    function updateProgress() {
      if (!currentAudio) return;
      const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
    }

    // Web Playback SDK functionality
    let player = null;
    let deviceId = null;
    let currentSearchResults = []; // Store current search results for auto-play
    let currentTrackIndex = 0; // Track current position in search results

    window.onSpotifyWebPlaybackSDKReady = () => {
      player = new Spotify.Player({
        name: 'SpotiLite Web Player',
        getOAuthToken: cb => { cb(getAccessToken()); }
      });

      // Error handling
      player.addListener('initialization_error', ({ message }) => {
        console.error('Failed to initialize:', message);
      });

      player.addListener('authentication_error', ({ message }) => {
        console.error('Failed to authenticate:', message);
      });

      player.addListener('account_error', ({ message }) => {
        console.error('Failed to validate Spotify account:', message);
      });

      player.addListener('playback_error', ({ message }) => {
        console.error('Failed to perform playback:', message);
      });

                    // Playback status updates
        player.addListener('player_state_changed', state => {
          if (state) {
            updatePlaybackUI(state);
            
            // Auto-play next track when current track ends
            if (state.paused && state.track_window.current_track) {
              // Check if track ended naturally (not paused by user)
              const currentPosition = state.position;
              const trackDuration = state.duration;
              
              // If we're near the end of the track (within 1 second), auto-play next
              if (trackDuration && currentPosition && (trackDuration - currentPosition) < 1000) {
                setTimeout(() => {
                  playNextTrack();
                }, 1000);
              }
            }
          }
        });

        // Add progress update listener for real-time progress bar
        setInterval(() => {
          if (player && deviceId) {
            player.getCurrentState().then(state => {
              if (state && state.track_window.current_track) {
                updateProgressBar(state.position, state.duration);
              }
            });
          }
        }, 1000);

      // Ready
      player.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        console.log('Ready with Device ID', device_id);
      });

      // Connect to the player
      player.connect();
    };

    function updatePlaybackUI(state) {
      if (state.track_window.current_track) {
        const track = state.track_window.current_track;
        document.getElementById('nowPlayingTitle').textContent = track.name;
        document.getElementById('nowPlayingArtist').textContent = track.artists.map(a => a.name).join(', ');
        document.getElementById('audioPlayer').classList.add('active');
        
        // Update progress
        if (state.position && state.duration) {
          updateProgressBar(state.position, state.duration);
        }
        
        // Update play/pause button with proper icons
        const playBtn = document.getElementById('playPauseBtn');
        if (state.paused) {
          // Show play button (triangle pointing right)
          playBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
          playBtn.title = 'Play';
        } else {
          // Show pause button (two vertical bars)
          playBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
          playBtn.title = 'Pause';
        }
      }
    }

    function updateProgressBar(position, duration) {
      if (position && duration) {
        const progress = (position / duration) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
      }
    }

    async function playFullTrack(spotifyUri, trackIndex = 0) {
      if (!deviceId) {
        notice.textContent = "Player not ready. Please wait...";
        return;
      }

      try {
        const token = await getAccessToken();
        const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            uris: [spotifyUri]
          })
        });

        if (response.ok) {
          currentTrackIndex = trackIndex;
          notice.textContent = "Playing full track!";
        } else {
          notice.textContent = "Failed to start playback";
        }
      } catch (error) {
        notice.textContent = "Playback error: " + error.message;
      }
    }

    async function playNextTrack() {
      if (currentSearchResults.length === 0 || currentTrackIndex >= currentSearchResults.length - 1) {
        notice.textContent = "No more tracks to play";
        return;
      }

      currentTrackIndex++;
      const nextTrack = currentSearchResults[currentTrackIndex];
      await playFullTrack(nextTrack.uri, currentTrackIndex);
    }

    async function playPreviousTrack() {
      if (currentSearchResults.length === 0 || currentTrackIndex <= 0) {
        notice.textContent = "No previous tracks";
        return;
      }

      currentTrackIndex--;
      const prevTrack = currentSearchResults[currentTrackIndex];
      await playFullTrack(prevTrack.uri, currentTrackIndex);
    }

    // Make functions globally accessible for HTML onclick handlers
    window.playFullTrack = playFullTrack;
    window.toggleWebPlayback = toggleWebPlayback;
    window.stopWebPlayback = stopWebPlayback;
    window.playNextTrack = playNextTrack;
    window.playPreviousTrack = playPreviousTrack;
    window.seekToPosition = seekToPosition;

    async function toggleWebPlayback() {
      if (!player || !deviceId) return;
      
      try {
        const token = await getAccessToken();
        
        // Get current playback state to determine if we should play or pause
        const stateResponse = await fetch('https://api.spotify.com/v1/me/player', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (stateResponse.ok) {
          const state = await stateResponse.json();
          
          if (state.is_playing) {
            // Currently playing, so pause
            await fetch('https://api.spotify.com/v1/me/player/pause', {
              method: 'PUT',
              headers: { 'Authorization': `Bearer ${token}` }
            });
          } else {
            // Currently paused, so resume
            await fetch('https://api.spotify.com/v1/me/player/play', {
              method: 'PUT',
              headers: { 'Authorization': `Bearer ${token}` }
            });
          }
        }
      } catch (error) {
        console.error('Toggle playback error:', error);
      }
    }

    async function stopWebPlayback() {
      if (!player || !deviceId) return;
      
      try {
        const token = await getAccessToken();
        const response = await fetch('https://api.spotify.com/v1/me/player/pause', {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        // Reset UI to stopped state
        document.getElementById('audioPlayer').classList.remove('active');
        document.getElementById('nowPlayingTitle').textContent = 'No track playing';
        document.getElementById('nowPlayingArtist').textContent = '';
        document.getElementById('progressFill').style.width = '0%';
        
        // Reset play button to play state
        const playBtn = document.getElementById('playPauseBtn');
        playBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
        playBtn.title = 'Play';
      } catch (error) {
        console.error('Stop playback error:', error);
      }
    }

    async function seekToPosition(event) {
      if (!player || !deviceId) return;
      
      const progressBar = event.currentTarget;
      const rect = progressBar.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const progressBarWidth = rect.width;
      const seekPercentage = clickX / progressBarWidth;
      
      try {
        const token = await getAccessToken();
        const response = await fetch(`https://api.spotify.com/v1/me/player/seek?position_ms=${Math.floor(seekPercentage * 1000)}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          // Update progress bar immediately for better UX
          document.getElementById('progressFill').style.width = (seekPercentage * 100) + '%';
        }
      } catch (error) {
        console.error('Seek error:', error);
      }
    }

    async function doSearch(q) {
      const token = await getAccessToken();
      if (!token) { notice.textContent = "Please log in to search."; return; }
      const types = Array.from(selected);
      if (!types.length) { notice.textContent = "Select at least one type (e.g. track, artist)."; return; }
      notice.textContent = "";
      const params = new URLSearchParams({
        q, type: types.join(","), limit: "24"
        // market: If user token exists, their account country takes precedence automatically.
      });
      const data = await fetchJSON(`https://api.spotify.com/v1/search?${params.toString()}`, token);
      
      // Store track results for auto-play functionality
      currentSearchResults = data.tracks?.items || [];
      currentTrackIndex = 0;
      
      renderItems(data);
    }

    // -----------------------------
    // BOOT
    // -----------------------------
    async function boot() {
      // 1) Handle redirect back with ?code=
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      const state = url.searchParams.get("state");
      const expectedState = localStorage.getItem(stateKey);

      if (code) {
        if (expectedState && state !== expectedState) {
          notice.textContent = "State mismatch; please try logging in again.";
          return;
        }
        try {
          await exchangeCodeForToken(code);
        } catch (e) {
          notice.textContent = "Login failed: " + e.message;
        }
      }

      // 2) If logged in, fetch profile for header UI
      const token = await getAccessToken();
      if (token) {
        try {
          const me = await fetchJSON("https://api.spotify.com/v1/me", token);
          setAuthUI(me);
        } catch {
          setAuthUI(null);
        }
      } else {
        setAuthUI(null);
      }
    }

    // Search form
    const form = document.getElementById("searchForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const q = document.getElementById("q").value.trim();
      if (!q) return;
      try { await doSearch(q); }
      catch (err) { notice.textContent = "Search error: " + err.message; }
    });

    boot();
  </script>
</body>
</html>
